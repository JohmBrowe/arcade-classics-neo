<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
  />
  <title>Arcade Classics Neo</title>

  <!-- Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // âœ… Your project settings
    window.SUPABASE_URL = "https://uleybdwkykcmpwavfgtt.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsZXliZHdreWtjbXB3YXZmZ3R0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NzAzNjgsImV4cCI6MjA3MDI0NjM2OH0.VdKYBlvEXIBXzD-MyljBB-zjalm0CRIZFeNTJM49_YU";
  </script>

  <style>
    :root {
      --bg:#0c0c10; --panel:#141426; --panel2:#10101c; --line:#23233a;
      --text:#e8e8ff; --muted:#aab3d9; --accent:#00e1ff; --accent2:#ffd44d; --good:#14c35f;
    }
    *{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%;touch-action:manipulation}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{padding:24px 14px;border-bottom:1px solid var(--line);text-align:center}
    h1{margin:0 0 6px;font-size:clamp(24px,5vw,36px);color:var(--accent)}
    main{max-width:920px;margin:0 auto;padding:18px 14px 96px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:14px;padding:14px;margin:14px 0;box-shadow:0 8px 28px rgba(0,0,0,.35)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{display:block;margin-bottom:8px;color:var(--muted)}
    select,button,input{background:#0f0f1c;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:16px}
    button{cursor:pointer}
    button.primary{background:#0f192a;border-color:#1f365c}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .codebox{background:#0a0f18;border:1px solid var(--line);border-radius:10px;padding:10px;word-break:break-all}
    footer{margin-top:20px;text-align:center;color:#bfbfbf}
    footer a{color:#66ccff;text-decoration:none;margin:0 8px}
    .badge{display:inline-block;margin-left:10px;padding:2px 10px;border-radius:999px;background:var(--good);color:#031;font-weight:700}
  </style>
</head>
<body>
  <header>
    <h1>ðŸŽ® Arcade Classics Neo <span id="adfreeBadge" style="display:none" class="badge">Ad-Free</span></h1>
    <div class="muted">Choose a game, tap Play, or sign in for your early-player code & PIN.</div>
  </header>

  <main>
    <!-- Game launcher -->
    <section class="card">
      <label for="gameSelect">Choose a game</label>
      <div class="row">
        <select id="gameSelect">
          <option value="games/tetris.html">Tetris</option>
          <option value="games/snake.html">Snake</option>
          <option value="games/chess.html">Chess</option>
          <option value="games/paper_minecraft.html">Paper Minecraft</option>
        </select>
        <button id="playBtn" class="primary">Play</button>
      </div>
    </section>

    <!-- Account -->
    <section class="card">
      <h2 style="margin:0 0 10px">Account</h2>

      <div id="signedOut">
        <div class="muted" style="margin-bottom:10px">Sign in with your email â€” weâ€™ll send a magic link (no password).</div>
        <div class="row">
          <input id="emailInput" type="email" placeholder="you@example.com" style="min-width:260px" />
          <button id="sendLinkBtn" class="primary">Send sign-in link</button>
        </div>
      </div>

      <div id="signedIn" style="display:none">
        <div class="muted" style="margin-bottom:6px">Signed in as <span id="who" class="mono"></span></div>

        <div style="margin:10px 0">
          <div style="font-weight:600;margin-bottom:4px">Early-Player Code</div>
          <div id="codeBox" class="codebox mono">â€¦</div>
        </div>

        <div style="margin:10px 0">
          <div style="font-weight:600;margin-bottom:4px">5-Digit PIN</div>
          <div id="pinBox" class="codebox mono">â€¦</div>
        </div>

        <div class="row">
          <button id="copyCodeBtn">Copy Code</button>
          <button id="emailCodeBtn">Email Code</button>
          <button id="emailPinBtn">Email PIN</button>
          <span class="muted" style="margin-left:auto">Keep these to unlock ad-free later.</span>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="signOutBtn">Sign out</button>
        </div>
      </div>
    </section>

    <!-- Ad-Free -->
    <section class="card" id="adfreeCard" style="display:none">
      <h2 style="margin:0 0 10px">Ad-Free</h2>
      <div id="adfreeState" class="muted">Sign in to enable ad-free on this device.</div>
      <div class="row" style="margin-top:10px">
        <button id="enableAdfree" class="primary">Enable Ad-Free</button>
        <button id="disableAdfree" style="display:none">Disable on this device</button>
        <span class="muted" style="margin-left:auto">Affects only this device/browser.</span>
      </div>
    </section>

    <footer>
      <a href="support.html">Support</a> Â·
      <a href="privacy.html">Privacy</a> Â·
      <a href="terms.html">Terms</a> Â·
      <a href="eula.html">EULA</a>
    </footer>
  </main>

  <script>
    // ---- Game launcher
    document.getElementById('playBtn').onclick = () =>
      (location.href = document.getElementById('gameSelect').value);

    // ---- Supabase client
    const { createClient } = supabase;
    const sb = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    // ---- DOM
    const signedOut = document.getElementById('signedOut');
    const signedIn  = document.getElementById('signedIn');
    const who = document.getElementById('who');
    const emailInput = document.getElementById('emailInput');
    const sendLinkBtn = document.getElementById('sendLinkBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const codeBox = document.getElementById('codeBox');
    const pinBox  = document.getElementById('pinBox');
    const copyCodeBtn = document.getElementById('copyCodeBtn');
    const emailCodeBtn = document.getElementById('emailCodeBtn');
    const emailPinBtn  = document.getElementById('emailPinBtn');

    // Ad-free UI
    const adCard    = document.getElementById('adfreeCard');
    const adState   = document.getElementById('adfreeState');
    const btnEnable = document.getElementById('enableAdfree');
    const btnDisable= document.getElementById('disableAdfree');
    const badge     = document.getElementById('adfreeBadge');

    // ---- Helpers
    const genPIN = () => String(Math.floor(Math.random()*100000)).padStart(5,'0');
    function genCode(len=20){
      const bytes = new Uint8Array(len);
      crypto.getRandomValues(bytes);
      const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      return Array.from(bytes, b => alphabet[b % alphabet.length]).join('');
    }

    async function ensureProfileAndSecrets(user){
      // profiles (email + pin)
      let { data: prof } = await sb.from('profiles')
        .select('email,pin').eq('id', user.id).maybeSingle();

      if(!prof){
        prof = { email:user.email, pin:genPIN() };
        await sb.from('profiles').insert({ id:user.id, email:prof.email, pin:prof.pin });
      }else if(!prof.pin){
        prof.pin = genPIN();
        await sb.from('profiles').update({ pin:prof.pin }).eq('id', user.id);
      }

      // player_codes (one per user)
      let { data: pc } = await sb.from('player_codes')
        .select('code').eq('user_id', user.id).maybeSingle();

      if(!pc){
        const code = genCode();
        await sb.from('player_codes').insert({ user_id:user.id, code });
        pc = { code };
      }

      return { pin: prof.pin, code: pc.code };
    }

    // ---- Ad-free (device-local flag)
    const isAdFree = () => localStorage.getItem('acn_adfree') === '1';
    const setAdFree = (v) => {
      localStorage.setItem('acn_adfree', v ? '1' : '0');
      applyAdFreeBadge();
    };
    function applyAdFreeBadge(){ badge.style.display = isAdFree() ? '' : 'none'; }

    function updateAdFreeUI(user){
      adCard.style.display = '';
      if(!user){
        adState.textContent = 'Sign in to enable ad-free on this device.';
        btnEnable.style.display=''; btnDisable.style.display='none';
        return;
      }
      if(isAdFree()){
        adState.textContent = 'Ad-Free is active on this device.';
        btnEnable.style.display='none'; btnDisable.style.display='';
      }else{
        adState.textContent = 'Tap Enable to activate ad-free on this device.';
        btnEnable.style.display=''; btnDisable.style.display='none';
      }
    }

    btnEnable.addEventListener('click', async ()=>{
      const { data:{ user }} = await sb.auth.getUser();
      if(!user) return alert('Sign in first.');
      // Secrets already ensured by refreshUI; trusting signed-in state here
      setAdFree(true);
      updateAdFreeUI(user);
    });
    btnDisable.addEventListener('click', async ()=>{
      setAdFree(false);
      const { data:{ user }} = await sb.auth.getUser();
      updateAdFreeUI(user);
    });
    applyAdFreeBadge();

    // ---- Auth UI
    async function refreshUI(){
      const { data:{ user }} = await sb.auth.getUser();
      if(!user){
        signedOut.style.display=''; signedIn.style.display='none';
        updateAdFreeUI(null);
        return;
      }
      signedOut.style.display='none'; signedIn.style.display='';
      who.textContent = user.email || '(no email)';
      const { pin, code } = await ensureProfileAndSecrets(user);
      pinBox.textContent = pin; codeBox.textContent = code;
      updateAdFreeUI(user);
    }

    sendLinkBtn.onclick = async ()=>{
      const email = (emailInput.value||'').trim();
      if(!email) return alert('Enter your email first.');
      const { error } = await sb.auth.signInWithOtp({
        email,
        options:{ emailRedirectTo: location.href }
      });
      if(error) alert(error.message); else alert('Check your inbox for the sign-in link!');
    };

    signOutBtn.onclick = async ()=>{ await sb.auth.signOut(); refreshUI(); };

    copyCodeBtn.onclick = async ()=>{
      try{ await navigator.clipboard.writeText(codeBox.textContent); alert('Code copied!'); }
      catch{ alert('Copy failed â€” select the text and copy manually.'); }
    };

    emailCodeBtn.onclick = async ()=>{
      const { data:{ user }} = await sb.auth.getUser();
      if(!user?.email) return alert('Sign in first.');
      location.href = 'mailto:' + encodeURIComponent(user.email)
        + '?subject=' + encodeURIComponent('Your Arcade Classics Neo Code')
        + '&body=' + encodeURIComponent('Your code: ' + codeBox.textContent + '\n\nKeep this for ad-free perks later.');
    };

    emailPinBtn.onclick = async ()=>{
      const { data:{ user }} = await sb.auth.getUser();
      if(!user?.email) return alert('Sign in first.');
      location.href = 'mailto:' + encodeURIComponent(user.email)
        + '?subject=' + encodeURIComponent('Your Arcade Classics Neo PIN')
        + '&body=' + encodeURIComponent('Your PIN: ' + pinBox.textContent);
    };

    sb.auth.onAuthStateChange(()=>refreshUI());
    refreshUI();
  </script>
</body>
</html>
